{% extends 'base.html' %}
{% load sum_tags %}

    <!-- title -->
    {% block title %}<title>Order</title>{% endblock %}
    <!-- style -->
    {% block extra-style %}
    <style>
        .content_header {
            width:100%;
            border-bottom: 1px solid black;
        }
        .PaymentSection_content{
            margin-top: 20px;
            margin-bottom: 20px;
            
            /* padding-top: 20px;
            padding-bottom: 20px; */
        }
        .content_title{
            width: 70px;
            padding-right: 12px;            
        }
        .PaymentSection_content_sub {
            margin-bottom: 8px;
        }   
        

    </style>
    {% endblock %}
    
<!-- body -->

{% block content %}
<div class="container">
    <!-- h1>32px h2>24px  아이디어스 28px  -->
   
    
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 40px 0 40px 0;">
        <h3 style="font-size: 18px; 
        font-weight: bold; 
        color: #333;">주문 결제</h3>
        <!-- 1 -->
        <div style="display:flex; color: gray; font-size: small;">
            <div style="margin-right: 8px; ">01</div><div style="margin-right: 8px;">장바구니</div>
            <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px; opacity: 1; fill: currentcolor;">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M9.53039 5.46973L15.5304 11.4697C15.7967 11.736 15.8209 12.1527 15.603 12.4463L15.5304 12.5304L9.53039 18.5304L8.46973 17.4697L13.9391 12.0001L8.46973 6.53039L9.53039 5.46973Z"></path>
            </svg>
        
        <!-- 2 active 확인필요-->
            <div style="display: flex; color: black; font-size: medium; font-weight: bold; margin-left: 8px;" class="OrderStepper--active">
                <div style="margin-right: 8px;">02</div><div style="margin-right: 8px;">주문결제</div>
            </div>
            <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px; opacity: 1; fill: currentcolor;">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9.53039 5.46973L15.5304 11.4697C15.7967 11.736 15.8209 12.1527 15.603 12.4463L15.5304 12.5304L9.53039 18.5304L8.46973 17.4697L13.9391 12.0001L8.46973 6.53039L9.53039 5.46973Z"></path>
            </svg>
        <!-- 3 -->
            <div style="display:flex; color: gray; font-size: small;">
                <div style="margin-right: 8px;">03</div><div style="margin-right: 8px;">주문완료</div>
            </div>            
        </div>
        
    </div>


    

    <!-- 카트나 상품페이지에서 담긴 유저의 구매목록 -->
    <div style="justify-content: space-between;    display: flex;    margin-bottom: 80px;"> 
    
        <div style="width:800px; margin-top:16px; margin-right:80px;">
            <div style="margin-bottom: 28px;">
                <div class="PaymentSection_title">
                    <div class="content_header"><span>주문 고객</span>
                        <!---->
                    </div>                    
                </div>
                <div>
                    <div class="PaymentSection_content">
                        <div class="PaymentSection_content_sub">
                            <span class="content_title">이메일</span>
                            <span class="PaymentMember_content">{{user}}</span>
                        </div>
                        <div class="PaymentSection_content_sub">
                            <span class="content_title">전화번호</span>
                            <span class="PaymentMember_content">{{user.phone_number}}</span>
                            <button type="outline" class="btn btn-sm btn-outline-primary" style="font-size: small; height: 28px; 
                            width: 76px;  margin-left: 20px; ">
                                <!---->
                                <span>변경하기</span>
                            </button>
                        </div>
                        <div class="PaymentSection_content_sub">주문, 배송시 등록된 번호로 SMS를 발송해 드립니다.</div>
                        <!---->
                    </div>
                        
                </div>
            </div>
                <div class="DesktopPaymentProductDelivery mb-[28px]">
                    <div class="DeliveryInformation white--background w-full flex flex-col">
                        <div class="flex justify-between items-center py-[16px] border-b border-[#333333]">
                            <div class="content_header">배송 정보</div>
                            <!---->
                        </div>
                        <div>
                            <div style="display: flex; 
                            justify-content: 
                            space-between; 
                            align-items: center;
                            flex-direction: column;
                            padding-top: 8px;
                            padding-bottom: 8px;
                            ">
                                <div class="PaymentSection_content">
                                <p class="mb-[8px] subtitle3-bold-medium">등록된 배송지가 없습니다</p>
                                <p class="mb-[16px] body1-regular-medium">배송지 추가하기 버튼을 눌러 주소를 입력해주세요</p>
                                <button type="outline" class="btn btn-sm btn-outline-primary">
                                    <svg  width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"  style="width: 20px; height: 20px; opacity: 1; fill: currentcolor; margin-right: 2px;">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.75 5V11.25H19V12.75H12.75V19H11.25V12.75H5V11.25H11.25V5H12.75Z"></path>
                                    </svg>
                                    <span >배송지 추가하기</span>
                                </button>
                                </div>
                            </div>
                            <!---->
                        </div>
                        <!---->
                    </div>                   
                </div>
                <div class="DesktopPaymentSection mb-[28px]">
                    <div class="DesktopPaymentSection__title">
                        <div class="content_header">
                            <span>주문 정보 ({{ object|length }})</span>
                            <!---->
                        </div>
                        
                    </div>
                    <div>
                        <div class="PaymentSection_content">
                            {% for item in object %}
                            <div style="display: flex;
                            flex-direction: column;
                            width: 100%;
                            margin-bottom: 12px;
                            ">                                
                                <div class="PaymentOrderList" style="display: flex;">
                                    <div class="BaseImage" style="margin-right:12px;">
                                        <div class="BaseImage_image">                                            
                                            <img style="width: 50px; border-radius: 8px;" src="{{ product.image.url }}"loading="lazy">
                                        </div>
                                    </div>
                                    <!--flex: 1; 아이템들 사이에 균등한 공간을 주기 위해 설정.-->
                                    <div class="PaymentOrderList_Info" style="flex: 1;">
                                        <div class="PaymentOrderList_productName"style="margin-bottom:12px;">
                                            <div style="display:flex;">
                                                <div  style="align-items: center;">{{item.product.product_name}}</div>
                                                <!---->
                                            </div>
                                        </div>
                                       <div>
                                            <div style="display:flex; justify-content: space-between;  margin-bottom: 12px;">
                                                <span>• 메뉴 : {{item.product.product_name}}</span>
                                                
                                                <div style=" justify-content: flex-end;">
                                                    <span >{{item.amount}}개</span>
                                                    <span class="mx-[4px]">/</span>
                                                    <span>{{item.total_price}}원</span>
                                                </div>
                                            </div>
                                        </div>
                                        <!---->
                                    </div>
                                </div>
                                <div class="PaymentOrderList_Total">
                                    <div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
                                        <span>배송비</span>
                                        <span>무료배송</span>
                                    </div>
                                    <!---->
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <!---->
                    </div>
                </div>
                <!----><!---->
                <div class="DesktopPaymentSection PaymentProductPayMethod">
                    <div class="PaymentSection_title">
                        <div class="content_header">
                            <span >결제 수단</span>                           
                            <!---->
                        </div>
                        <div class="PaymentSection_content">
                            <span>간편 비밀번호 결제</span>
                            <!---->
                        </div>
                    </div>
                   
                    </div>
               </div>
                    <div style="width: 400px;">
                        <div class="PaymentProduct_Total">
                            <div class="PaymentProductTotal">
                                <div class="PaymentSection">
                                    <div class="PaymentSection_title">
                                        <div class="content_header"><span >결제 정보</span>
                                            <!---->
                                        </div>
                                        
                                    </div>
                                    <div >
                                        <div class="PaymentSection_content" style="display: flex; justify-content: space-between;">
                                            <div class="body1-regular-small">작품금액</div>
                                            <div class="DesktopPaymentProductTotal__price">{% sum_prices object %}원</div>
                                        </div>
                                        <div  class="PaymentSection_content" style="display: flex; justify-content: space-between;">
                                            <div  class="body1-regular-small">배송비</div>
                                            <div  class="DesktopPaymentProductTotal__price">무료배송</div>
                                        </div>
                                        <!---->
                                        
                                        <div style="display: flex; justify-content: space-between;">
                                            <div style="font-weight: bold;">최종 결제금액</div>
                                            <div class="text-right">
                                                <div>{% sum_prices object %}원</div>
                                            </div>
                                        </div>                                    
                                        <div class="PaymentNotice">
                                            <div class="PaymentNotice_title">
                                                <input type="checkbox" id="agree-checkbox">
                                                <span style="font-size: small; color:#333;">결제 시 개인정보 제공에 동의합니다.</span>
                                                <button class="btn btn-outline-info" onclick="btn_notice_Click()" style="font-size: 12px; padding: 5px 5px; border: none;">▼</button>
                                            </div>
                                            
                                            <div class="PaymentNotice_content" id="notice-btn" style="display: none;">
                                                
                                                ‣ 제공받는 자 : 
                                                <b style=" font-weight: bold;">{{user.role}}</b>
                                                <br>
                                                ‣ 목적 : 
                                                <b style=" font-weight: bold;">
                                                    판매자와 구매자 사이의 원활한 거래 진행, 상품의 배송을 위한 배송지 확인, 고객상담 및 불만처리 등
                                                </b>
                                                <br>
                                                ‣ 정보 : 주문자 정보(성명, 연락처), 수령인 정보(성명, 연락처, 주소)
                                                <br>
                                                ‣ 보유기간 : 
                                                <b style=" font-weight: bold;">발송완료 후 15일</b>
                                                <br>
                                                <br>
                                                SELLER는 통신판매중개자이며 통신판매의 당사자가 아닙니다. 따라서 SELLER는 상품 거래정보 및 거래에 대하여 책임을 지지 않습니다.
                                                <br>고객님께서는 개인정보 제공에 대하여 동의를 거부하실 수 있으나, 거부 시 상품 구매가 어렵습니다.
                                            </div>
                                        </div>
                                            <form method="post">
                                                {% csrf_token %}                                                
                                                <!-- 모달 버튼 -->
                                                <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                id="pay-button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#pay-modal"
                                                data-bs-userName="{{user}}"                                                
                                                data-bs-price="{{price}}"
                                                disabled
                                                >결제하기</button>
                                        
                                            </form>
                                        <!---->
                                        <!-- 모달 -->
                                        <div class="modal fade" id="pay-modal" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalLabel">결제</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <!-- 결제 폼-->
                                                        <form id="payment-btn" action="{% url 'order:order_done' %}" method="post">
                                                            {% csrf_token %}
                                                            <!-- 주문자 이름 -->
                                                            <div class="mb-3">
                                                                <label class="form-label">주문자</label>
                                                                <input class="form-control form-control-sm" id="userName" value="{{user}}" readonly>
                                                            </div>
                                                            <!-- 상품 이름 -->
                                                            <div class="mb-3">
                                                                <label class="form-label">총금액</label>
                                                                <input class="form-control form-control-sm" id="productPrice" value="{% sum_prices object %}" readonly >
                                                            </div>
                                                            <!-- 상품 가격 -->
                                                            <div class="mb-3">
                                                                <label class="form-label">결제 비밀번호</label>
                                                                <input class="form-control form-control-sm" id="user-password">
                                                            </div>
                                                            <!-- 히든 인풋 -->
                                                            <input type="hidden" id="productId">
                                                            <input type="hidden" id="csrfToken" value="{{csrf_token}}">
                                                            <!-- 전송 버튼 -->
                                                            <button type="button" class="btn btn-outline-primary btn-sm" id="pay-btn" onclick="password_confirm()">
                                                                결제
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <!---->
        </div>
</div>


<!-- CryptoJS 라이브러리 추가 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>  
    function getCsrfToken(){
                return document.getElementById('csrfToken').value;
            }
    function hashPassword(password) {
        // 비밀번호를 SHA-256 해시로 변환
        var hash = CryptoJS.SHA256(password);
        return hash.toString(CryptoJS.enc.Hex);
    }

    // 모달 내의 비밀번호 입력란과 함께 "결제" 버튼을 클릭하면, 비밀번호를 포함하여 모든 필요한 데이터를 서버로 전송합니다.
    // 서버에서는 전달받은 비밀번호를 안전한 방식으로 검증하고, 일치 여부를 확인합니다.
    // 검증 결과에 따라 적절한 응답을 생성하여 클라이언트에게 전달합니다. 일치하는 경우에는 결제가 성공적으로 이루어지도록 처리합니다.
    function password_confirm(){
        var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "order:password_confirm" %}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', getCsrfToken());
            
            input_password = document.getElementById('user-password').value
            // var hashed_password = hashPassword(input_password);  // 입력한 비밀번호를 해시화

            xhr.send('input_password=' + input_password);  // 해시화된 비밀번호를 서버로 전송

            xhr.onload = function() {
                if (this.status === 200) {
                    var response = JSON.parse(this.responseText);
                    if (response.message === '비밀번호가 확인되었습니다.') {
                        alert('비밀번호가 확인되었습니다.');
                        document.getElementById('payment-btn').submit();
                    } else {
                        alert('비밀번호가 맞지 않습니다.');
                        console.log('입력한 password: ' + input_password);
                        console.log('DB에 저장된 password: ' + response.db_password);
                    }
                    // **
                    console.log('Confirm successful:', response.message);
                } else {
                    console.error('Error updating:', this.statusText);
                }
            };

    }

    {
     //모달 버튼 변수화
     const payModal = document.querySelectorAll("#pay-modal");
    //모달 이벤트
    payModal.forEach(btn => {
        btn.addEventListener("show.bs.modal", (event) => {
            //트리거 버튼 선택
            const triggerBtn = event.relatedTarget;
            //데이터 가져옴
            const userName = triggerBtn.getAttribute("data-bs-userName");
            // const productName = triggerBtn.getAttribute("data-bs-productName");
            const productPrice = triggerBtn.getAttribute("data-bs-price");

            //데이터 반영
            document.querySelector("#userName").value = userName;
            document.querySelector("#productName").value = productPrice;
            // document.querySelector("#productPrice").value = productPrice;
        });
    });
    }
    // 개인정보제공 버튼 클릭 시 #notice-btn 보이기/숨김 
    function btn_notice_Click() {
        const noticediv = document.getElementById('notice-btn');

        if(noticediv.style.display === 'none') {
            noticediv.style.display = 'block';
        } 
        else {
            noticediv.style.display = 'none';
        }
    }
    // 체크박스가 체크되면 결제하기 버튼 활성화, 체크 해제되면 비활성화
    document.getElementById('agree-checkbox').addEventListener('change', function() {
        var payButton = document.getElementById('pay-button');
        payButton.disabled = !this.checked; 
    });   
    
</script>
{% endblock %}

